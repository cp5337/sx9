#!/usr/bin/env python3
"""Hash prompts + inputs deterministically to support load set provenance."""
import hashlib, os, sys, json
def sha256_file(p):
    h=hashlib.sha256()
    with open(p,'rb') as f:
        for ch in iter(lambda: f.read(1024*1024), b''): h.update(ch)
    return 'sha256:'+h.hexdigest()
def composite(files):
    h=hashlib.sha256()
    for p in sorted(files):
        rel=os.path.relpath(p, sys.argv[1])
        h.update(rel.encode()+b'='+sha256_file(p).encode()+b'\n')
    return 'sha256:'+h.hexdigest()
def main(root):
    prompts=[]; inputs=[]
    for d,_,fs in os.walk(os.path.join(root,'agents')):
        for fn in fs: prompts.append(os.path.join(d,fn))
    for d,_,fs in os.walk(os.path.join(root,'sx9-canonical')):
        for fn in fs: inputs.append(os.path.join(d,fn))
    out={'prompt_hash': composite(prompts), 'canonical_hash': composite(inputs)}
    print(json.dumps(out, indent=2, sort_keys=True))
if __name__=='__main__':
    if len(sys.argv)!=2: raise SystemExit('usage: sx9-hash <bundle_root>')
    main(sys.argv[1])
